import json
import sys
import os
import pandas as pd


def read_excel_to_text(file_path: str) -> dict:
    """
    Reads an Excel file and exports its data into a text file.
    Also returns the parsed data in JSON response.
    """

    try:
        # Validate file
        if not file_path or not os.path.exists(file_path):
            return {
                "error": f"File not found: {file_path}",
                "capability": "read_excel_to_text"
            }

        # Read first sheet
        df = pd.read_excel(file_path)

        # Convert dataframe to text lines
        lines = []

        # Add header line
        header = ", ".join(df.columns.astype(str))
        lines.append(f"COLUMNS: {header}")

        # Add each row
        for _, row in df.iterrows():
            values = ", ".join(str(v) for v in row.values)
            lines.append(values)

        text_content = "\n".join(lines)

        # Build output text file path
        output_txt_path = os.path.join(
            os.path.dirname(file_path),
            "excel_output.txt"
        )

        # Write to text file
        with open(output_txt_path, "w", encoding="utf-8") as f:
            f.write(text_content)

        return {
            "result": {
                "message": "Excel read successfully",
                "columns": list(df.columns),
                "row_count": len(df),
                "text_file": output_txt_path,
                "sample_rows": df.head(5).to_dict(orient="records")
            },
            "capability": "read_excel_to_text"
        }

    except Exception as e:
        return {
            "error": str(e),
            "capability": "read_excel_to_text"
        }


def main():
    """Main entry point - reads JSON from stdin, outputs JSON to stdout"""
    try:
        input_data = json.load(sys.stdin)

        capability = input_data.get("capability")
        args = input_data.get("args", {})

        if capability == "read_excel_to_text":
            result = read_excel_to_text(
                file_path=args.get("file_path")
            )
            print(json.dumps(result, indent=2))

        else:
            print(json.dumps({
                "error": f"Unknown capability: {capability}",
                "capability": capability
            }, indent=2))

    except Exception as e:
        print(json.dumps({
            "error": f"Error: {str(e)}",
            "capability": "unknown"
        }, indent=2))
        sys.exit(1)


if __name__ == "__main__":
    main()
